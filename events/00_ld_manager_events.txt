namespace = ld

character_event = {
    id = ld.1000
    hide_window = yes
    is_triggered_only = yes

    # Desync prevention: Only run deterministic cleanup if ld_desync_mode is set to ld_mp_safe
    immediate = {
        if = {
            limit = {
                has_character_flag = ld_queue_cleanup_needed
                game_rule = { ld_desync_mode = ld_mp_safe }
            }
            remove_character_flag = ld_queue_cleanup_needed
            every_scheme = {
                limit = {
                    scheme_target_character = {
                        OR = { exists = no is_alive = no }
                    }
                }
                end_scheme = yes
            }
        }
        # If ld_desync_mode is ld_full, vanilla logic applies (add any non-deterministic actions here if needed)
    }
}